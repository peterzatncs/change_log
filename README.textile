h1. Change Log

A gem to keep all changes about the record in database.
It automatically saves who made the changes at what time and what has been changed into a single database table.
You can choose the columns which you want to keep the changes.
Ignores columns like 'updated_at', 'created_at' and 'password' etc.


h2. Install Change Log Gem

1. by command:
<pre><code># gem install change_log</code></pre>
   Then in your environment.rb:
<pre><code>config.gem 'change_log'</code></pre>


2. or by bundler:
<pre><code># Gemfile in your application
gem 'change_log'
</code></pre>

Then:
<pre><code>bundle install</code></pre>

* Note: 
        If you use bundler with Rails 2.3.x, you may get "enable_change_log" method missing error. 
        This is because Rails 2.3.x comes with its own gem handling. 
        You need to override that and replace it with support for Bundler. 
        Visit "Bundler Website":http://gembundler.com/rails23.html to find out how.

h2. Create a table to keep all changes

    Generate a migration file

<pre><code>
    class AddChangeLog < ActiveRecord::Migration
      def self.up
        create_table :change_logs do |t|
         t.integer :version, :null=>false      # store version of each change
         t.string :record_id,:limit=>30        # store the actual record id 
         t.string :table_name, :limit=>60      # store the table name 
         t.string :attribute_name,:limit=>60   # store the column name
         t.string :user, :limit=>20            # store the user who made the change
         t.string :action, :limit=>6           # store the change action: create, read, update, delete
         t.text :old_value                     # the value before change
         t.text :new_value                     # value after change
         t.string :field_type, :limit=>30      # the column type eg. date, text, varchar, int etc
         t.timestamps
        end
      end

      def self.down
        drop_table :change_logs
      end
    end
</code></pre>

Then:
<pre><code>rake db:migrate</code></pre> 

h2. Use Change Log

    1. *Add current_user Method in application_controller.rb*

This method will tell change_log who is the current user
<pre><code>
def current_user 
  return session[:user] # replace this with your own code
end
</code></pre>

    2. *ActiveRecord Models*
If you want to enable change_log for any ActiveRecord Model, 
just put following line in very beginning of model file.
<pre><code>
enable_change_log :ignore=>[:updated_at]    
</code></pre>

Put any columns you do not want to keep in the change log table in :ignore option.
eg. the password hash


    3.  *About the ChangeLogs Model*
ChangeLogs model is core ActiveRecord model used by change_log gem.

You can use it directly in your model, controller even in helper.

For example:
<pre><code># List all changes
ChangeLogs.find(:all)</code></pre>

<pre><code># List all changes made by user 'peterz'
ChangeLogs.find(:all,:conditions=>['user = ?', 'peterz'])</code></pre>

<pre><code># List all changes for table 'accounts'
ChangeLogs.find(:all,:conditions=>['table_name = ?', 'accounts'])</code></pre>   

* Note: 
        It is ok if you want to use other table name instead of 'change_logs',
        choose your preferred table name and run the migration.
        Just remember in your environment.rb file, you need to tell change_log gem 
        what is your table name:

<pre><code># config/environment.rb
ChangeLogs.set_table_name('hr_maintenances')
</code></pre>

h2. Testing

    TODO


h3. Author
----

Peter Zhang at NCS New Zealand.
Email: peterz@ncs.co.nz

Copyright (c) 2011 Peter Zhang, released under the MIT license